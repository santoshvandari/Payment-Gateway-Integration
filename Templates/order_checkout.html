{% extends 'base.html' %}

{% block title %}Checkout - Order {{ order.order_id }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h2 class="mb-4">Order Checkout</h2>
        
        <!-- Order Details Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Order Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Order ID:</strong> {{ order.order_id }}</p>
                        <p><strong>Customer Name:</strong> {{ order.name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Amount:</strong> Rs. {{ order.total_price }}</p>
                        <p><strong>Status:</strong> 
                            {% if order.is_paid %}
                                <span class="badge bg-success">Paid</span>
                            {% else %}
                                <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% if not order.is_paid %}
        <!-- Payment Gateway Selection -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Select Payment Method</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">Choose your preferred payment gateway to complete the payment.</p>
                
                <div class="row">
                    <!-- eSewa Payment -->
                    <div class="col-md-6 mb-3">
                        <div class="card payment-gateway-card h-100" onclick="selectPaymentGateway('esewa')">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <img src="https://esewa.com.np/common/images/esewa_logo.png" alt="eSewa" style="height: 60px;" onerror="this.style.display='none'">
                                </div>
                                <h5 class="card-title">eSewa</h5>
                                <p class="card-text text-muted">Pay securely with eSewa digital wallet</p>
                                <form method="POST" id="esewa-form" style="display: none;">
                                    {% csrf_token %}
                                    <input type="hidden" name="payment_method" value="esewa">
                                </form>
                                <button type="button" class="btn esewa-btn text-white" onclick="document.getElementById('esewa-form').submit();">
                                    Pay with eSewa
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Khalti Payment -->
                    <div class="col-md-6 mb-3">
                        <div class="card payment-gateway-card h-100" onclick="selectPaymentGateway('khalti')">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <img src="https://web.khalti.com/static/img/logo1.png" alt="Khalti" style="height: 60px;" onerror="this.style.display='none'">
                                </div>
                                <h5 class="card-title">Khalti</h5>
                                <p class="card-text text-muted">Pay securely with Khalti digital wallet</p>
                                <form method="POST" id="khalti-form" style="display: none;">
                                    {% csrf_token %}
                                    <input type="hidden" name="payment_method" value="khalti">
                                </form>
                                <button type="button" class="btn khalti-btn text-white" onclick="document.getElementById('khalti-form').submit();">
                                    Pay with Khalti
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <strong>Note:</strong> Both payment gateways are configured for testing. Use test credentials provided by the respective payment services.
                    <ul class="mt-2 mb-0">
                        <li><strong>eSewa Test:</strong> Use test merchant ID and any valid amount</li>
                        <li><strong>Khalti Test:</strong> Use test public key for integration</li>
                    </ul>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Already Paid Message -->
        <div class="card">
            <div class="card-body text-center">
                <div class="text-success mb-3">
                    <i class="fas fa-check-circle fa-3x"></i>
                </div>
                <h4 class="text-success">Payment Already Completed</h4>
                <p class="text-muted">This order has been paid successfully.</p>
                <p><strong>Payment Method:</strong> {{ order.payment_method }}</p>
                <p><strong>Transaction ID:</strong> {{ order.transaction_id }}</p>
                <a href="{% url 'order_success' order.id %}" class="btn btn-success">View Receipt</a>
                <a href="{% url 'order_list' %}" class="btn btn-secondary">Back to Orders</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function selectPaymentGateway(gateway) {
    // Visual feedback for selection
    document.querySelectorAll('.payment-gateway-card').forEach(card => {
        card.classList.remove('border-primary');
    });
    event.currentTarget.classList.add('border-primary');
}
</script>
{% endblock content %}